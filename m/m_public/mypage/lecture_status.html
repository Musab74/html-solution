<? include "../include/mypage_header.html"; ?>
<? include "../../m_archive/include/top_header.html";?>
<? include "../../m_archive/include/mypage_header.html";?>

<? //include "../include/login_check.php"; ?>
<!-- 페이징에 영향을 주는 form 태그 -->
<form name="listScriptForm1" method="GET" action="<?=$_SERVER['PHP_SELF']?>">
<input type="hidden" name="pg1" value="<?=$pg1?>">
</form>
<form name="listScriptForm2" method="GET" action="<?=$_SERVER['PHP_SELF']?>">
<input type="hidden" name="pg2" value="<?=$pg2?>">
</form>
<form name="listScriptForm3" method="GET" action="<?=$_SERVER['PHP_SELF']?>">
<input type="hidden" name="pg3" value="<?=$pg3?>">
</form>
<?
##-- 수강기간 확인
$Sql = "SELECT LectureStart , LectureEnd, PassOK FROM Study WHERE ID = '$LoginMemberID'";
//echo $Sql;
$Result = mysqli_query($connect, $Sql);
$Row    = mysqli_fetch_array($Result);
if($Row) {
	$LectureStart = $Row['LectureStart'];
	$LectureEnd   = $Row['LectureEnd'];
    $PassOK       = $Row['PassOK'];
}

$where = " WHERE a.ID = '$LoginMemberID' AND c.StudyEnd='N' AND a.RegDate > c.LectureStart  AND a.RegDate < c.LectureEnd ";
$where2 = " AND a.RegDate > '$LectureStart' AND a.RegDate < '$LectureEnd' AND c.StudyEnd = 'N' ";

$JoinQuery = " Progress a
            LEFT OUTER JOIN Course b ON a.LectureCode = b.LectureCode 
            LEFT JOIN Study c ON a.ID = c.ID ";

##-- 페이징
$pg1 = Replace_Check_XSS2($pg1);
$pg2 = Replace_Check_XSS2($pg2);
$pg3 = Replace_Check_XSS2($pg3);

##-- 페이지 조건
$page_size = 5;
$block_size = 10;
//이러닝
if(!$pg1) $pg1 = 1;
//마이크로닝
if(!$pg2) $pg2 = 1;
//숏폼
if(!$pg3) $pg3 = 1;

##-- 검색 등록수
//이러닝 카운트
$SqlA = "SELECT COUNT(DISTINCT(a.LectureCode)) FROM $JoinQuery $where AND b.ServiceType = 'X' ";
$ResultA = mysqli_query($connect, $SqlA);
$RowA = mysqli_fetch_array($ResultA);
$CNT1 = $RowA[0];
//마이크로닝 카운트
$SqlB = "SELECT COUNT(DISTINCT(a.LectureCode)) FROM $JoinQuery $where AND b.ServiceType = 'Z' ";
$ResultB = mysqli_query($connect, $SqlB);
$RowB = mysqli_fetch_array($ResultB);
$CNT2 = $RowB[0];
//숏폼 카운트
$SqlC = "SELECT COUNT(DISTINCT(a.LectureCode)) FROM $JoinQuery $where AND b.ServiceType = 'Y' ";
$ResultC = mysqli_query($connect, $SqlC);
$RowC = mysqli_fetch_array($ResultC);
$CNT3 = $RowC[0];

##-- 페이지 클래스 생성
include_once("../../m_include/include_page2.php");

//이러닝
$PAGE_CLASS1 = new Page($pg1,$CNT1,$page_size,$block_size); ##-- 페이지 클래스
$BLOCK_LIST1 = $PAGE_CLASS1->blockList('X'); ##-- 페이지 이동관련
$PAGE_UNCOUNT1 = $PAGE_CLASS1->page_uncount; ##-- 게시물 번호 한개씩 감소
//마이크로닝
$PAGE_CLASS2 = new Page($pg2,$CNT2,$page_size,$block_size); ##-- 페이지 클래스
$BLOCK_LIST2 = $PAGE_CLASS2->blockList('Y'); ##-- 페이지 이동관련
$PAGE_UNCOUNT2 = $PAGE_CLASS2->page_uncount; ##-- 게시물 번호 한개씩 감소
//숏폼
$PAGE_CLASS3 = new Page($pg3,$CNT3,$page_size,$block_size); ##-- 페이지 클래스
$BLOCK_LIST3 = $PAGE_CLASS3->blockList('Z'); ##-- 페이지 이동관련
$PAGE_UNCOUNT3 = $PAGE_CLASS3->page_uncount; ##-- 게시물 번호 한개씩 감소
?>
        <div class="mypage_content">
            <div class="sb_box">
                <ul>
                    <li class="on"><a href="lecture_status.html">학습 중인 과정</a></li>
                    <li><a href="lecture_status02.html">학습완료 과정</a></li>
                    <li><a href="lecture_status03.html">관심 과정</a></li>
                </ul>
            </div>
            <div class="top_category">
                <?
            	//총학습시간
            	$SqlD = "SELECT SUM(a.StudyTime) AS TotalProgressTime , c.PassOK  
            			 FROM Progress a
            			 LEFT JOIN Study c ON a.ID = c.ID
            			 WHERE a.ID = '$LoginMemberID' $where2";
				//echo $SqlD;
				$ResultD = mysqli_query($connect, $SqlD);
				$RowD    = mysqli_fetch_array($ResultD);

				$TotalStudyTime = gmdate("H: i", $RowD['TotalProgressTime']);
				$Time_array     = explode(': ',$TotalStudyTime);
				
				if($RowD['PassOK']=="Y") $PassOKStr = "(수료)";
				else $PassOKStr = "(미수료)";
				?>
                <div>
                    <strong>총 학습시간</strong>
                    <p><b><?=$Time_array[0]?></b>시간<b><?=$Time_array[1]?></b>분<em><?=$PassOKStr?></em></p>
                </div>
            </div>
             <div class="test-btn">
                <?
                // $nowDate = date('Y-m-d');
                // $beforeDete = date('Y-m-d', strtotime($ROWS['LectureEnd'] . ' -30 days'));
                // if ( $beforeDete < $nowDate ) { //수강기간 한달전부터 사후진단 버튼 활성화
                if ( $PassOK == "Y" ) { // 250515 원래 30일이었다가 수료 시점으로 변경됨
                ?> 
                    <button onclick="location.href='/m_archive/post/post_test01.html'" >사후역량진단 하러가기<i class="ph ph-caret-right"></i></button>
                <?} ?>
            </div> 
            <div class="content">
            	<?
            	//총학습시간
            	$SqlD = "SELECT SUM(a.StudyTime) FROM Progress a
            			 LEFT JOIN Study c ON a.ID = c.ID
            			 WHERE a.ID = '$LoginMemberID' $where2";
				//echo $SqlD;
				$ResultD = mysqli_query($connect, $SqlD);
				$RowD    = mysqli_fetch_array($ResultD);

				$TotalStudyTime = gmdate("H: i", $RowD[0]);
				$Time_array     = explode(': ',$TotalStudyTime);
				?>

                <!--이러닝-->
                <div class="table_wrap" id="e-learning">
                    <h2>이러닝</h2>
                    <table>
                        <colgroup>
                            <!--<col  class="mh"  width="5%">-->
                            <col width="*%">
                            <!--<col  class="mh" width="7%">
                            <col  class="mh" width="7%">
                            <col  class="mh" width="7%">
                            <col  class="mh"  width="10%">
                            <col  class="mh"  width="10%"> -->
                            <col  width="90px">
                            <!-- <col  class="mh"  width="90px"> -->
                        </colgroup>
                        <thead>
                            <tr>
                                <!--<th  class="mh" >NO</th>-->
                                <th>과정명</th>
                                <!--<th class="mh" >과정시간</th>
                                <th class="mh" >이수시간</th>
                                <th class="mh" >진도율</th>
                                <th  class="mh" >수강 시작일</th>
                                <th  class="mh" >최근 학습일</th> -->
                                <th>학습하기</th>
                                <!--<th class="mh" >이수증</th>-->
                            </tr>
                        </thead>
                        <tbody>
						<?
						$i = 1;
						$sql = "SELECT 	DISTINCT(a.LectureCode), a.ID , a.Study_Seq ,
		                        		b.ServiceType , b.ContentsName , b.Chapter , b.ContentsTime ,
		                        		(SELECT RegDate FROM ProgressLog WHERE ID = a.ID AND LectureCode = a.LectureCode ORDER BY idx LIMIT 1) AS StartDate,
		                        		(SELECT RegDate FROM ProgressLog WHERE ID = a.ID AND LectureCode = a.LectureCode ORDER BY idx DESC LIMIT 1) AS RecentDate,
		                        		(SELECT FLOOR((SUM(IF(Progress>100,100,Progress)))/(b.Chapter*100)*100) AS TotalProgress FROM Progress WHERE ID =  a.ID AND LectureCode = a.LectureCode) AS Progress,
		                        		(SELECT SUM(StudyTime) FROM Progress WHERE ID =  a.ID AND LectureCode = a.LectureCode) AS StudyTime
                                        ,  c.LectureCode AS StudyLectureCode
								FROM $JoinQuery
								$where AND b.ServiceType = 'X'
								ORDER BY (SELECT FLOOR((SUM(IF(Progress>100,100,Progress)))/(b.Chapter*100)*100) AS TotalProgress FROM Progress WHERE ID = a.ID AND LectureCode = a.LectureCode)
								LIMIT $PAGE_CLASS1->page_start, $page_size";
						//echo $sql;	echo "<br>";
						$query = mysqli_query($connect, $sql);
						if($query && mysqli_num_rows($query)){
							while($row = mysqli_fetch_array($query)){
								extract($row);

								$StudyTime = gmdate("H:i:s", $row['StudyTime']);
								if($Progress > 100) $Progress = 100;
						?>
							<tr>
                                <!--<td class="mh"><?=$PAGE_UNCOUNT1--?></td>-->
                                <td style="text-align: left;"><?=$ContentsName?></td>
                                <!--<td class="mh"><?=$ContentsTime?>분</td>
                                <td class="mh"><?=$StudyTime?></td>
                                <td class="mh"><?=$Progress?>%</td>
                                <td class="mh"><?=$StartDate?></td>
                                <td class="mh"><?=$RecentDate?></td>-->
                                <td>
								<?if($Chapter == "0"){?>
									<button class="white" onclick="Javascript:ContentsPlayer('<?=$LectureCode?>');">학습하기</button>
								<?}else{?>
		                            <button class="white" onclick="Javascript:ContentsPlayer2('<?=$LectureCode?>', '1', '<?=$Study_Seq?>', '<?=$StudyLectureCode?>');">학습하기</button>
	                            <?}?>
								</td>
                                <!--<td class="mh">
								<?if($Progress >= 100){?>
									<button class="black" onclick="Javascript:CertificatePrint('<?=$LectureCode?>');">이수증</button>
								<?}?>
								</td>-->
                            </tr>
						<?
                        		$i++;
							}
						}else{
						?>
							<tr>
								<td colspan="9">학습이력이 존재하지 않습니다.</td>
							</tr>
						<?
						}
						?>
                        </tbody>
                    </table>
                    <!-- page -->
                    <?=$BLOCK_LIST1?>
                    <!-- //page -->
                </div>
                <!--//이러닝-->

                <!--마이크로러닝-->
                <div class="table_wrap" id="micro-learning">
                    <h2>마이크로러닝</h2>
                    <table>
                        <colgroup>
                            <!--<col  class="mh"  width="5%">-->
                            <col width="*%">
                            <!--<col  class="mh" width="7%">
                            <col  class="mh" width="7%">
                            <col  class="mh" width="7%">
                            <col  class="mh"  width="10%">
                            <col  class="mh"  width="10%">-->
                            <col  width="90px">
                            <!--<col  class="mh"  width="90px">-->
                        </colgroup>
                        <thead>
                            <tr>
                                <!--<th  class="mh" >NO</th>-->
                                <th>과정명</th>
                                <!--<th class="mh" >과정시간</th>
                                <th class="mh" >이수시간</th>
                                <th class="mh" >진도율</th>
                                <th  class="mh" >수강 시작일</th>
                                <th  class="mh" >최근 학습일</th>-->
                                <th >학습하기</th>
                                <!--<th class="mh" >이수증</th>-->
                            </tr>
                        </thead>
                        <tbody>
						<?
						$i = 1;
						$sql = "SELECT 	DISTINCT(a.LectureCode), a.ID , a.Study_Seq ,
		                        		b.ServiceType , b.ContentsName , b.Chapter , b.ContentsTime ,
		                        		(SELECT RegDate FROM ProgressLog WHERE ID = a.ID AND LectureCode = a.LectureCode ORDER BY idx LIMIT 1) AS StartDate,
		                        		(SELECT RegDate FROM ProgressLog WHERE ID = a.ID AND LectureCode = a.LectureCode ORDER BY idx DESC LIMIT 1) AS RecentDate,
		                        		(SELECT FLOOR((SUM(IF(Progress>100,100,Progress)))/(b.Chapter*100)*100) AS TotalProgress FROM Progress WHERE ID =  a.ID AND LectureCode = a.LectureCode) AS Progress,
		                        		(SELECT SUM(StudyTime) FROM Progress WHERE ID =  a.ID AND LectureCode = a.LectureCode) AS StudyTime
                                        ,  c.LectureCode AS StudyLectureCode
								FROM $JoinQuery
								$where AND b.ServiceType = 'Z'
								ORDER BY (SELECT FLOOR((SUM(IF(Progress>100,100,Progress)))/(b.Chapter*100)*100) AS TotalProgress FROM Progress WHERE ID = a.ID AND LectureCode = a.LectureCode) 
								LIMIT $PAGE_CLASS2->page_start, $page_size";
						//echo $sql; echo "<br>";
						$query = mysqli_query($connect, $sql);
						if($query && mysqli_num_rows($query)){
							while($row = mysqli_fetch_array($query)){
								extract($row);

								$StudyTime = gmdate("H:i:s", $row['StudyTime']);
								if($Progress > 100) $Progress = 100;
						?>
							<tr>
                                <!--<td class="mh"><?=$PAGE_UNCOUNT2--?></td>-->
                                <td style="text-align: left;"><?=$ContentsName?></td>
                                <!--<td class="mh"><?=$ContentsTime?>분</td>
                                <td class="mh"><?=$StudyTime?></td>
                                <td class="mh"><?=$Progress?>%</td>
                                <td class="mh"><?=$StartDate?></td>
                                <td class="mh"><?=$RecentDate?></td>-->
                                <td>
									<?if($Chapter == "0"){?>
									<button class="white" onclick="Javascript:ContentsPlayer('<?=$LectureCode?>');">학습하기</button>
									<?}else{?>
		                            <button class="white" onclick="Javascript:ContentsPlayer2('<?=$LectureCode?>', '1', '<?=$Study_Seq?>', '<?=$StudyLectureCode?>');">학습하기</button>
		                            <?}?>
								</td>
                                <!--<td class="mh">
								<?if($Progress >= 100){?>
									<button class="black" onclick="Javascript:CertificatePrint('<?=$LectureCode?>');">이수증</button>
								<?}?>
                                </td>-->
                            </tr>
						<?
                        		$i++;
                        	}
						}else{
						?>
							<tr>
								<td colspan="9">학습이력이 존재하지 않습니다.</td>
							</tr>
						<?
						}
						?>
                        </tbody>
                    </table>
                    <!-- page -->
                    <?=$BLOCK_LIST2?>
                    <!-- //page -->
                </div>
                <!--//마이크로러닝-->

                <!--숏폼-->
                <div class="table_wrap" id="short-form">
                    <h2>숏폼</h2>
                    <table>
                        <colgroup>
                            <!--<col  class="mh"  width="5%">-->
                            <col width="*%">
                            <!--<col  class="mh" width="7%">
                            <col  class="mh" width="7%">
                            <col  class="mh" width="7%">
                            <col  class="mh"  width="10%">
                            <col  class="mh"  width="10%">-->
                            <col  width="90px">
                            <!--<col  class="mh"  width="90px">-->
                        </colgroup>
                        <thead>
                            <tr>
                                <!--<th  class="mh" >NO</th>-->
                                <th>과정명</th>
                                <!--<th class="mh" >과정시간</th>
                                <th class="mh" >이수시간</th>
                                <th class="mh" >진도율</th>
                                <th  class="mh" >수강 시작일</th>
                                <th  class="mh" >최근 학습일</th>-->
                                <th >학습하기</th>
                                <!--<th class="mh" >이수증</th>-->
                            </tr>
                        </thead>
                        <tbody>
                        <?
						$i = 1;
						$sql = "SELECT 	DISTINCT(a.LectureCode), a.ID , a.Study_Seq ,
		                        		b.ServiceType , b.ContentsName , b.Chapter , b.ContentsTime ,
		                        		(SELECT RegDate FROM ProgressLog WHERE ID = a.ID AND LectureCode = a.LectureCode ORDER BY idx LIMIT 1) AS StartDate,
		                        		(SELECT RegDate FROM ProgressLog WHERE ID = a.ID AND LectureCode = a.LectureCode ORDER BY idx DESC LIMIT 1) AS RecentDate,
		                        		(SELECT FLOOR((SUM(IF(Progress>100,100,Progress)))/(b.Chapter*100)*100) AS TotalProgress FROM Progress WHERE ID =  a.ID AND LectureCode = a.LectureCode) AS Progress,
		                        		(SELECT SUM(StudyTime) FROM Progress WHERE ID =  a.ID AND LectureCode = a.LectureCode) AS StudyTime
                                        ,  c.LectureCode AS StudyLectureCode
								FROM $JoinQuery
								$where AND b.ServiceType = 'Y'
								ORDER BY (SELECT FLOOR((SUM(IF(Progress>100,100,Progress)))/(b.Chapter*100)*100) AS TotalProgress FROM Progress WHERE ID = a.ID AND LectureCode = a.LectureCode)
								LIMIT $PAGE_CLASS3->page_start, $page_size";
						//echo $sql;
						$query = mysqli_query($connect, $sql);
						if($query && mysqli_num_rows($query)){
							while($row = mysqli_fetch_array($query)){
								extract($row);

								$StudyTime = gmdate("H:i:s", $row['StudyTime']);
								if($Progress > 100) $Progress = 100;
						?>
							<tr>
                                <!--<td class="mh"><?=$PAGE_UNCOUNT3--?></td>-->
                                <td style="text-align: left;"><?=$ContentsName?></td>
                                <!--<td class="mh"><?=$ContentsTime?>분</td>
                                <td class="mh"><?=$StudyTime?></td>
                                <td class="mh"><?=$Progress?>%</td>
                                <td class="mh"><?=$StartDate?></td>
                                <td class="mh"><?=$RecentDate?></td>-->
                                <td>
									<?if($Chapter == "0"){?>
									<button class="white" onclick="Javascript:ContentsPlayer('<?=$LectureCode?>');">학습하기</button>
									<?}else{?>
		                            <button class="white" onclick="Javascript:ContentsPlayer2('<?=$LectureCode?>', '1', '<?=$Study_Seq?>', '<?=$StudyLectureCode?>');">학습하기</button>
		                            <?}?>
								</td>
                                <!--<td class="mh">
								<?if($Progress >= 100){?>
									<button class="black" onclick="Javascript:CertificatePrint('<?=$LectureCode?>');">이수증</button>
								<?}?>
                                </td>-->
                            </tr>
                        <?
                        		$i++;
                        	}
						}else{
						?>
							<tr>
								<td colspan="9">학습이력이 존재하지 않습니다.</td>
							</tr>
						<?
						}
						?>
                        </tbody>
                    </table>
                    <!-- page -->
                    <?=$BLOCK_LIST3?>
                    <!-- //page -->
                </div>
                <!--//마이크로러닝-->

            </div>
        </div>
    </div>
</body>
<? include "../../m_archive/include/footer.html"; ?>
<script>

    $(document).ready(function(){
        $('.top-menu .lecture').addClass("on");
    });
    
    function navigateToCourse() {
        var selectedValue = document.getElementById("courseSelect").value;
        if (selectedValue) {
            window.location.href = selectedValue;
        }
    }
</script>